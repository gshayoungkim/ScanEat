{% extends "base.html" %}

{% block title %}Product Requests - ScanEat{% endblock %}

{% block head_extra %}
<style>
    /* í˜ì´ì§€ë³„ ìŠ¤íƒ€ì¼ */
    body { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }
    
    .contact-container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        padding: 40px;
        flex: 1;
    }
    
    h1 { font-size: 32px; margin-bottom: 16px; color: #333; }
    h2 { font-size: 20px; margin-top: 24px; margin-bottom: 12px; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
    p { line-height: 1.8; color: #555; margin-bottom: 16px; }
    label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; margin-top: 16px; }
    input, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; margin-bottom: 16px; box-sizing: border-box; }
    input[type="submit"] { background: #667eea; color: white; cursor: pointer; font-weight: bold; border: none; }
    input[type="submit"]:hover { background: #764ba2; }
    
    .back-link {
        display: inline-block;
        margin-bottom: 24px;
        padding: 10px 16px;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.3s;
    }
    .back-link:hover { 
        background: #764ba2;
        transform: translateX(-3px);
    }
    
    .form-section { 
        background: #f9f9f9; 
        padding: 24px; 
        border-radius: 8px; 
        margin-bottom: 32px; 
        border-left: 4px solid #667eea; 
    }
    
    .board-section { margin-top: 40px; }
    
    .request-item { 
        background: #f0f4ff; 
        padding: 16px; 
        border-radius: 8px; 
        margin-bottom: 12px; 
        border-left: 4px solid #667eea; 
    }
    
    .request-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: start; 
        gap: 12px; 
    }
    
    .request-title { font-weight: bold; font-size: 16px; color: #333; }
    .request-details { margin-top: 8px; font-size: 13px; color: #666; }
    .request-date { font-size: 12px; color: #999; margin-top: 8px; }
    
    .status-badge { 
        display: inline-block; 
        padding: 4px 12px; 
        border-radius: 20px; 
        font-size: 12px; 
        font-weight: bold; 
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    
    .message-box { 
        padding: 12px; 
        border-radius: 4px; 
        margin-bottom: 16px; 
    }
    .message-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    
    .empty-state { 
        text-align: center; 
        padding: 40px; 
        color: #999; 
    }
    
    .tab-buttons { 
        display: flex; 
        gap: 12px; 
        margin-bottom: 24px; 
        border-bottom: 2px solid #e0e0e0; 
    }
    .tab-btn { 
        padding: 12px 24px; 
        background: transparent; 
        color: #333; 
        border: none; 
        cursor: pointer; 
        font-size: 16px; 
        border-radius: 4px 4px 0 0;
        transition: all 0.3s;
    }
    .tab-btn.active { 
        background: #667eea; 
        color: white; 
        font-weight: bold; 
    }
    .tab-btn:hover {
        background: rgba(102, 126, 234, 0.1);
    }
</style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9118651721155215"
 crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="contact-container">
    <a href="/" class="back-link">â† Back to Home</a>

    <!-- ì–¸ì–´ íƒ­ -->
    <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchLanguage('en', event)">English</button>
        <button class="tab-btn" onclick="switchLanguage('ko', event)">í•œêµ­ì–´</button>
    </div>

    <!-- ì˜ì–´ ë²„ì „ -->
    <div id="en" style="display: block;">
        <h1>ğŸ“ Product Requests Board</h1>
        <p>Help us expand our database! If a product is not found in our system, you can request it here.</p>

        <div class="form-section">
            <h2>Request a Product</h2>
            <div id="messageEn"></div>
            <form id="productForm">
                <label for="productName">Product Name <span style="color: red;">*</span></label>
                <input type="text" id="productName" placeholder="e.g., Lotte Peppero" required>

                <label for="productCode">Product Report Number (Optional)</label>
                <input type="text" id="productCode" placeholder="e.g., 20020464088">

                <label for="barcode">Barcode Number (Optional)</label>
                <input type="text" id="barcode" placeholder="e.g., 8801019602498">

                <input type="submit" value="Submit Request">
            </form>
        </div>

        <div class="board-section">
            <h2>Recent Requests</h2>
            <div id="requestListEn">
                <div class="empty-state">Loading...</div>
            </div>
        </div>
    </div>

    <!-- í•œêµ­ì–´ ë²„ì „ -->
    <div id="ko" style="display: none;">
        <h1>ğŸ“ ìƒí’ˆ ìš”ì²­ ê²Œì‹œíŒ</h1>
        <p>ìš°ë¦¬ì˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™•ëŒ€í•˜ëŠ”ë° ë„ì›€ì„ ì£¼ì„¸ìš”! ì‹œìŠ¤í…œì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ìƒí’ˆì„ ì—¬ê¸°ì„œ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <div class="form-section">
            <h2>ìƒí’ˆ ìš”ì²­í•˜ê¸°</h2>
            <div id="messageKo"></div>
            <form id="productFormKo">
                <label for="productNameKo">ìƒí’ˆëª… <span style="color: red;">*</span></label>
                <input type="text" id="productNameKo" placeholder="ì˜ˆ: ë¡¯ë° ë¹¼ë¹¼ë¡œ" required>

                <label for="productCodeKo">í’ˆëª©ë³´ê³ ë²ˆí˜¸ (ì„ íƒì‚¬í•­)</label>
                <input type="text" id="productCodeKo" placeholder="ì˜ˆ: 20020464088">

                <label for="barcodeKo">ë°”ì½”ë“œë²ˆí˜¸ (ì„ íƒì‚¬í•­)</label>
                <input type="text" id="barcodeKo" placeholder="ì˜ˆ: 8801019602498">

                <input type="submit" value="ìš”ì²­ ì œì¶œ">
            </form>
        </div>

        <div class="board-section">
            <h2>ìµœê·¼ ìš”ì²­ ëª©ë¡</h2>
            <div id="requestListKo">
                <div class="empty-state">ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentLang = 'en';

    function switchLanguage(lang, event) {
        event.preventDefault();
        currentLang = lang;
        document.getElementById('en').style.display = lang === 'en' ? 'block' : 'none';
        document.getElementById('ko').style.display = lang === 'ko' ? 'block' : 'none';
        
        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        loadRequests();
    }

    // í¼ ì œì¶œ
    document.getElementById('productForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitRequest('en');
    });

    document.getElementById('productFormKo').addEventListener('submit', async function(e) {
        e.preventDefault();
        await submitRequest('ko');
    });

    async function submitRequest(lang) {
        const nameId = lang === 'en' ? 'productName' : 'productNameKo';
        const codeId = lang === 'en' ? 'productCode' : 'productCodeKo';
        const barcodeId = lang === 'en' ? 'barcode' : 'barcodeKo';
        const messageId = lang === 'en' ? 'messageEn' : 'messageKo';
        const formId = lang === 'en' ? 'productForm' : 'productFormKo';

        const productName = document.getElementById(nameId).value.trim();
        const productCode = document.getElementById(codeId).value.trim();
        const barcode = document.getElementById(barcodeId).value.trim();

        try {
            const response = await fetch('/api/request-product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productName, productCode, barcode })
            });

            const data = await response.json();
            const messageDiv = document.getElementById(messageId);

            if (response.ok) {
                messageDiv.className = 'message-box message-success';
                messageDiv.innerHTML = 'âœ“ ' + data.message;
                document.getElementById(formId).reset();
                setTimeout(() => loadRequests(), 500);
            } else {
                messageDiv.className = 'message-box message-error';
                messageDiv.innerHTML = 'âœ— ' + data.error;
            }
            messageDiv.style.display = 'block';
            setTimeout(() => messageDiv.style.display = 'none', 5000);
        } catch (error) {
            const messageDiv = document.getElementById(messageId);
            messageDiv.className = 'message-box message-error';
            messageDiv.innerHTML = 'âœ— Error: ' + error.message;
            messageDiv.style.display = 'block';
        }
    }

    async function loadRequests() {
        try {
            const response = await fetch('/api/product-requests?limit=20');
            const data = await response.json();

            const listEn = document.getElementById('requestListEn');
            const listKo = document.getElementById('requestListKo');

            if (data.length === 0) {
                listEn.innerHTML = '<div class="empty-state">No requests yet. Be the first to request a product!</div>';
                listKo.innerHTML = '<div class="empty-state">ì•„ì§ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ë¡œ ìƒí’ˆì„ ìš”ì²­í•´ì£¼ì„¸ìš”!</div>';
                return;
            }

            let html = '';
            data.forEach(item => {
                const date = new Date(item.created_at).toLocaleDateString();
                const statusText = item.status === 'pending' ? 'Pending' : item.status === 'completed' ? 'Completed' : 'Rejected';
                const statusBadge = `<span class="status-badge status-${item.status}">${statusText}</span>`;

                const detailsEn = `${item.product_code ? `<div class="request-details">ğŸ“Œ Code: ${item.product_code}</div>` : ''}${item.barcode ? `<div class="request-details">ğŸ“Š Barcode: ${item.barcode}</div>` : ''}`;
                const detailsKo = `${item.product_code ? `<div class="request-details">ğŸ“Œ ì½”ë“œ: ${item.product_code}</div>` : ''}${item.barcode ? `<div class="request-details">ğŸ“Š ë°”ì½”ë“œ: ${item.barcode}</div>` : ''}`;

                html += `
                    <div class="request-item">
                        <div class="request-header">
                            <div style="flex: 1;">
                                <div class="request-title">${item.product_name}</div>
                                ${currentLang === 'en' ? detailsEn : detailsKo}
                                <div class="request-date">${date}</div>
                            </div>
                            ${statusBadge}
                        </div>
                    </div>
                `;
            });

            listEn.innerHTML = html;
            listKo.innerHTML = html;
        } catch (error) {
            console.error('Failed to load requests:', error);
            document.getElementById('requestListEn').innerHTML = '<div class="empty-state">Failed to load requests</div>';
            document.getElementById('requestListKo').innerHTML = '<div class="empty-state">ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨</div>';
        }
    }

    // ì´ˆê¸° ë¡œë“œ
    loadRequests();
</script>
{% endblock %}
